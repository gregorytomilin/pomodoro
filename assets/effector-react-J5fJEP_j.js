import{R as i}from"./react-BfF-YriY.js";import{a as g,F as C,D as R}from"./effector-wP0dD7uT.js";import{A as V}from"./use-sync-external-store-CZSEbpyg.js";function P(n,e){const m=g.unit(n);let r={};m?r={unit:n}:"@@unitShape"in n?typeof n["@@unitShape"]=="function"?r=n["@@unitShape"]():K("expect @@unitShape to be a function"):r=n;const k=Array.isArray(r),l=i.useRef({stale:1,justSubscribed:0,scope:e}),[j,d,h,b,y]=i.useMemo(()=>{l.current.stale=1;const t=Array.isArray(r)?[]:{},s=[],f=[],u=[],v=[];for(const c in r){if(!{}.hasOwnProperty.call(r,c))continue;const o=r[c];g.unit(o)||K(`expect useUnit ${m?"argument":`value in key "${c}"`} to be a unit`),g.event(o)||g.effect(o)?(t[c]=e?C(o,{scope:e}):o,u.push(c),v.push(o)):(t[c]=null,s.push(c),f.push(o))}return[t,s,f,u,v]},[l,e,...Object.keys(r),...Object.values(r)]),x=i.useRef({value:j,storeKeys:d,eventKeys:b,eventValues:y}),A=i.useCallback(t=>{const s=l.current;return s.justSubscribed=1,R({unit:h,fn:()=>{s.stale||(s.stale=1,t())},scope:e,batch:1})},[h,e,x,l]),E=i.useCallback(()=>{const t=x.current,s=l.current;let f,u=0;const v=t.value,c=t.storeKeys,o=t.eventKeys,w=t.eventValues,O=e!==s.scope;if(s.stale||s.justSubscribed||O){u=!s.justSubscribed||O,f=k?[...j]:{...j},c.length===d.length&&o.length===b.length||(u=1);for(let a=0;a<d.length;a++){const S=D(h[a],e),p=d[a];u||(u=c.includes(p)?v[p]!==S:1),f[p]=S}for(let a=0;a<b.length;a++){const S=y[a],p=b[a];u||(u=o.includes(p)?w[o.indexOf(p)]!==S:1)}}return u&&(t.value=f),t.storeKeys=d,t.eventKeys=b,t.eventValues=y,s.stale=0,s.justSubscribed=!u,s.scope=e,m?t.value.unit:t.value},[A,h,y,e,x,l]);return $(A,E,E)}function U(n){const e=i.useContext(F);return n&&!e&&K("No scope found, consider adding <Provider> to app root"),e}function q(n,e){return P(n,U(e==null?void 0:e.forceScope))}const K=n=>{throw Error(n)};typeof window<"u"?i.useLayoutEffect:i.useEffect;const{useSyncExternalStore:$}=V,D=(n,e)=>e?e.getState(n):n.getState(),F=i.createContext(null);export{q as c};
